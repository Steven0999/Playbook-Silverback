<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Basketball Playbook - Animated</title>
  <!-- Load Tailwind CSS for modern, mobile-first styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* CSS Variables for theme */
    :root { 
      --court-fill: #f6e7bf; /* Light brown/tan court color */
      --line: #1f1f1f; /* Dark line color */
      --border-color: #b57b2a; /* Darker brown border */
    }
    /* Base Styling and Typography */
    body { 
      font-family: 'Inter', Arial, sans-serif; 
      margin: 0; 
      padding: 18px; 
      background: #fafafa;
    }

    /* Court Container */
    .court-container { 
      width: 100%; 
      max-width: 980px; 
      margin: 0 auto; 
      border-radius: 12px; 
      border: 6px solid var(--border-color); 
      background: var(--court-fill); 
      overflow: hidden; 
      touch-action: none; 
      box-shadow: 0 15px 35px rgba(181, 123, 42, 0.5); 
    }
    .court-inner { 
      width: 100%; 
      height: 0; 
      padding-bottom: 53.19%; /* Aspect ratio for 94x50 court (50/94 * 100) */
      position: relative; 
    }
    svg { 
      position: absolute; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      display: block; 
      z-index: 1; /* SVG containing lines is below tokens */
    }
    
    /* Tokens (Players & Ball) - HTML DIVs */
    .token { 
      position: absolute; 
      width: 38px; 
      height: 38px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: #fff; 
      font-weight: 700; 
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
      cursor: default; 
      user-select: none;
      /* Main transition for smooth movement */
      transition: box-shadow 0.3s, transform 0.3s, background-color 0.2s, left 0.6s ease-in-out, top 0.6s ease-in-out;
      z-index: 10; /* Higher Z-index ensures tokens are above all SVG lines */
    }
    .ball { 
      width: 32px; /* Slightly larger ball */
      height: 32px; 
      font-size: 24px; 
      background: none; 
      box-shadow: none; 
      z-index: 11; /* Ball slightly higher than players */
      transition: left 0.6s ease-in-out, top 0.6s ease-in-out;
    }

    /* Highlight class for players involved in the current step */
    .highlighted {
        border: 3px solid white;
        transform: scale(1.15);
        z-index: 12;
    }

    /* Styles for the dynamic lines in SVG */
    .play-action-line {
        fill: none;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease-out;
    }
    
    /* --- ANIMATED PLAY/PAUSE BUTTON STYLES --- */
    #play-pause-button {
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-bar {
      position: absolute;
      width: 10px; /* Width of the pause bar */
      height: 28px; /* Height of the pause bar */
      background-color: white;
      border-radius: 2px;
      transition: transform 0.3s ease-in-out, 
                  height 0.3s ease-in-out, 
                  width 0.3s ease-in-out, 
                  left 0.3s ease-in-out;
      transform-origin: center center;
    }
    /* Bar 1 (Left Pause Bar) */
    #bar1 {
      left: 14px;
      transform: translateX(0); /* Initial position for pause */
    }
    /* Bar 2 (Right Pause Bar) */
    #bar2 {
      left: 36px;
      transform: translateX(0); /* Initial position for pause */
    }
    /* Bar 3 (Triangle Tip) - hidden in pause state */
    #bar3 {
      width: 0;
      height: 0;
      left: 25px;
      top: 25px;
      opacity: 0;
      background-color: transparent;
      transform: rotate(0deg);
      transition: all 0.3s ease-in-out;
    }

    /* PLAY State (Morphing into Triangle) */
    #play-pause-button.play-state #bar1 {
      /* Rotate left bar to be the top-left edge of the triangle */
      height: 48px;
      left: 25px; /* Center both bars */
      transform: rotate(60deg) translate(8px, -8px);
    }
    #play-pause-button.play-state #bar2 {
      /* Rotate right bar to be the bottom-left edge of the triangle */
      height: 48px;
      left: 25px; /* Center both bars */
      transform: rotate(-60deg) translate(-8px, -8px);
    }
    #play-pause-button.play-state #bar3 {
      /* This element acts as the right edge/closure of the triangle */
      width: 10px;
      height: 40px;
      background-color: white;
      opacity: 1;
      left: 26px;
      transform: rotate(180deg) translate(0px, 0px); /* A simple vertical bar that completes the shape */
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8">
  <!-- Toast Notification (Replaces alert) -->
  <div id="toast-notification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white p-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50"></div>

  <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Silverbacks Playbook</h1>
  
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-4 sm:p-6 mb-6">
    <!-- Tabs Navigation -->
    <div class="flex border-b border-gray-200 overflow-x-auto">
      <button data-play="Motion" class="play-tab px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent text-gray-500 hover:text-indigo-600 focus:outline-none transition-colors duration-200 whitespace-nowrap">
        Motion
      </button>
      <button data-play="Stack" class="play-tab px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent text-gray-500 hover:text-indigo-600 focus:outline-none transition-colors duration-200 whitespace-nowrap">
        Stack (Baseline Out)
      </button>
      <button data-play="HighLow" class="play-tab px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent text-gray-500 hover:text-indigo-600 focus:outline-none transition-colors duration-200 whitespace-nowrap">
        High/Low (Page 6)
      </button>
    </div>

    <!-- Play Instructions -->
    <div id="play-instructions" class="mt-4 p-3 bg-indigo-50 rounded-lg text-gray-700 text-sm sm:text-base">
      <p id="play-description" class="font-medium">Select a play above to begin, then use the "Next Step" or "Play" buttons to run the play sequence.</p>
    </div>

    <!-- Controls for Sequencing and Court View -->
    <div class="controls flex flex-wrap justify-center items-center gap-3 mt-5">
      
      <!-- Play/Pause Button (50px x 50px) -->
      <button 
        id="play-pause-button" 
        class="bg-indigo-600 hover:bg-indigo-700 shadow-lg text-white rounded-full w-14 h-14 p-2 transition-all duration-300 pause-state" 
        aria-label="Play or Pause Animation"
        disabled
      >
        <div id="bar1" class="icon-bar"></div>
        <div id="bar2" class="icon-bar"></div>
        <div id="bar3" class="icon-bar"></div>
      </button>

      <button id="toggle" class="bg-indigo-500 text-white hover:bg-indigo-600 rounded-lg p-2 transition-colors">Toggle: Full Court ‚Üí Half Court</button>
      
      <button id="reset-play" class="bg-red-500 text-white hover:bg-red-600 rounded-lg p-2 transition-colors">Reset Play</button>
      
      <button id="prev-step" class="bg-gray-300 text-gray-800 hover:bg-gray-400 disabled:opacity-50 font-bold rounded-lg p-2 transition-colors" disabled>
        ‚Üê Prev
      </button>
      <button id="next-step" class="bg-green-500 text-white hover:bg-green-600 disabled:opacity-50 font-bold rounded-lg p-2 transition-colors" disabled>
        Next Step ‚Üí
      </button>
    </div>
  </div>

  <div class="court-container" id="court">
    <div class="court-inner" id="courtInner">
      <!-- SVG Court Rendering (NBA 94x50) -->
      <svg id="courtSVG" viewBox="0 0 940 500" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
        <!-- Main Court Surface -->
        <rect x="0" y="0" width="940" height="500" fill="var(--court-fill)" />
        <!-- Court Boundary (Inner line) -->
        <rect x="6" y="6" width="928" height="488" rx="6" fill="none" stroke="#b57b2a" stroke-width="6" />
        
        <!-- Center Line and Circle -->
        <line id="midLine" x1="470" y1="0" x2="470" y2="500" stroke="var(--line)" stroke-width="5" />
        <circle id="midCircle" cx="470" cy="250" r="60" fill="none" stroke="var(--line)" stroke-width="5" />
        
        <!-- Dynamic Actions Group (PASSES/SCREENS/MOVEMENT) -->
        <g id="actionLines" class="z-0"></g>

        <!-- Left End (Baseline) -->
        <g id="leftEnd">
          <!-- Free Throw Lane (The Key) -->
          <rect x="0" y="170" width="190" height="160" fill="none" stroke="var(--line)" stroke-width="5" />
          <!-- Free Throw Circle (Top of Key) -->
          <circle cx="190" cy="250" r="60" fill="none" stroke="var(--line)" stroke-width="5" stroke-dasharray="0" />
          <!-- Restricted Area Arc (4ft from rim) -->
          <path d="M 40 230 A 20 20 0 0 1 40 270" fill="none" stroke="var(--line)" stroke-width="5" />
          <!-- Basket/Rim (4ft from baseline) -->
          <circle cx="50" cy="250" r="6" fill="var(--line)" />
          <!-- Backboard (2ft from baseline) -->
          <line x1="44" y1="235" x2="44" y2="265" stroke="var(--line)" stroke-width="6" />
          <!-- 3-Point Line Path (Generated by JS) -->
          <path id="left3pt" fill="none" stroke="var(--line)" stroke-width="5" />
        </g>

        <!-- Right End (Baseline) -->
        <g id="rightEnd">
          <!-- Free Throw Lane (The Key) -->
          <rect x="750" y="170" width="190" height="160" fill="none" stroke="var(--line)" stroke-width="5" />
          <!-- Free Throw Circle (Top of Key) -->
          <circle cx="750" cy="250" r="60" fill="none" stroke="var(--line)" stroke-width="5" stroke-dasharray="0" />
          <!-- Restricted Area Arc (4ft from rim) -->
          <path d="M 900 230 A 20 20 0 0 0 900 270" fill="none" stroke="var(--line)" stroke-width="5" />
          <!-- Basket/Rim (4ft from baseline) -->
          <circle cx="890" cy="250" r="6" fill="var(--line)" />
          <!-- Backboard (2ft from baseline) -->
          <line x1="896" y1="235" x2="896" y2="265" stroke="var(--line)" stroke-width="6" />
          <!-- 3-Point Line Path (Generated by JS) -->
          <path id="right3pt" fill="none" stroke="var(--line)" stroke-width="5" />
        </g>
      </svg>
    </div>
  </div>
  
  <script>
    // --- Constant Definitions ---
    const SCALE = 10;
    const COURT_LENGTH_FT = 94;
    const COURT_WIDTH_FT = 50;
    const RIM_FROM_BASELINE_FT = 4;
    const THREE_PT_RADIUS_FT = 23.75;
    const THREE_POINT_SIDE_FT = 22;
    const playerBaseSize = 38;
    const ballBaseSize = 32;
    const ANIMATION_DELAY = 600; // Time in ms for player movement (matches CSS transition)

    // --- State Variables ---
    let isFullCourt = true;
    let currentPlay = null; 
    let currentStepIndex = 0;
    let isPlaying = false; // Animation state
    let animationTimeout = null; // Stores the setTimeout ID
    
    // Stores { id: {x: number, y: number} } map of the previous step in SVG coordinates
    let lastStepPositions = {}; 

    // --- DOM Elements ---
    const courtInner = document.getElementById('courtInner');
    const playDescription = document.getElementById('play-description');
    const toggleButton = document.getElementById('toggle');
    const prevButton = document.getElementById('prev-step');
    const nextButton = document.getElementById('next-step');
    const playPauseButton = document.getElementById('play-pause-button');
    const actionLinesGroup = document.getElementById('actionLines');

    // --- Playbook Data (Updated for Point Guard position) ---
    // All coordinates are stored as a percentage of the FULL 94-foot court (0-100%).
    const PLAYBOOK = {
        Motion: [
            { // Step 0: Starting Position (Point Guard past the arc)
                description: "Initial Setup: Point Guard (1) at the high top, past the 3-point arc. Wings (2, 3) outside the arc. Bigs (4, 5) on the low blocks.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 35, y: 50, isBall: false }, // PG deeper
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 25, y: 85, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 7.5, y: 35, isBall: false }, // Low Post Strong Side
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 65, isBall: false }, // Low Post Weak Side
                    { id: 6, label: 'üèÄ', color: 'none', x: 35.5, y: 50, isBall: true } // Ball with PG
                ],
                highlight: [1, 6],
                actions: []
            },
            { // Step 1: Pass to Wing and Initial Cut (4 and 5 stay low)
                description: "1 passes to the Wing (2). 1 cuts to the weak side wing. Bigs (4, 5) maintain low post positions in preparation for the screen.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 10, y: 70, isBall: false }, // 1 cuts to weak side wing
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 85, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 10, y: 35, isBall: false }, // 4 stays low block
                    { id: 5, label: '5', color: '#8b5cf6', x: 10, y: 65, isBall: false }, // 5 STAYS LOW BLOCK
                    { id: 6, label: 'üèÄ', color: 'none', x: 25.5, y: 15, isBall: true }
                ],
                highlight: [1, 2, 6],
                actions: [
                    { type: 'pass', fromId: 1, toId: 2 }, 
                ]
            },
            { // Step 2: Screen Action (4/5 NO MOVEMENT/SWAP)
                description: "Screen Action: 1 screens for 3 (Weak Side Wing Swap). Big (4) sets a **screen** for Big (5). Both 4 and 5 remain locked in their low post positions.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 7.5, y: 85, isBall: false }, // 1 screens
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 10, y: 70, isBall: false }, // 3 pops
                    { id: 4, label: '4', color: '#3b82f6', x: 10, y: 35, isBall: false }, // 4 screens, NO MOVEMENT
                    { id: 5, label: '5', color: '#8b5cf6', x: 10, y: 65, isBall: false }, // 5 uses screen, NO MOVEMENT
                    { id: 6, label: 'üèÄ', color: 'none', x: 25.5, y: 15, isBall: true } 
                ],
                highlight: [1, 3, 4, 5],
                actions: [
                    { type: 'screen', fromId: 1, toId: 3 }, 
                    { type: 'screen', fromId: 4, toId: 5 }
                ]
            },
            { // Step 3: Reset and Bigs Swap (4/5 NOW SWAP)
                description: "**Position Swap (4 & 5):** Wing (2) dribbles to the top of the key. **Position 4** pops out to the high weak side, and **Position 5** cuts across to the strong-side low block, completing the requested post swap.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 35, y: 85, isBall: false }, // P1 cuts to high weak wing
                    { id: 2, label: '2', color: '#f59e0b', x: 35, y: 50, isBall: false }, // P2 dribbles to PG spot
                    { id: 3, label: '3', color: '#10b981', x: 23, y: 15, isBall: false }, // P3 cuts to strong corner
                    { id: 4, label: '4', color: '#3b82f6', x: 40, y: 80, isBall: false }, // P4 (was low) pops high weak side (SWAP)
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, // P5 (was low) cuts to strong low block (SWAP)
                    { id: 6, label: 'üèÄ', color: 'none', x: 35.5, y: 50, isBall: true } // Ball with 2 (new PG)
                ],
                highlight: [2, 4, 5, 6],
                actions: [] 
            }
        ],
        Stack: [
            { // Step 0: Starting Position (Inbounds)
                description: "Initial Setup for Stack: Big (4), Guard (3), Big (5), Guard (2) stacked from the block. Inbounder (1) under the basket.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 1, y: 50, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 7.5, y: 75, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 65, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 7.5, y: 55, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 45, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 1, y: 50, isBall: true }     
                ],
                highlight: [5, 6],
                actions: []
            },
            { // Step 1: First Big Cuts
                description: "First Big (5) cuts across the key to the opposite low block (= Option 1).",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 1, y: 50, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 7.5, y: 75, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 65, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 7.5, y: 55, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 1, y: 50, isBall: true }
                ],
                highlight: [5],
                actions: [
                    { type: 'pass', fromId: 1, toId: 5 }
                ]
            },
            { // Step 2: First Guard Cuts
                description: "First Guard (4) cuts to the corner (= Option 2 shot).",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 1, y: 50, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 7.5, y: 75, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 65, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 23, y: 15, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 1, y: 50, isBall: true }
                ],
                highlight: [4],
                actions: [
                    { type: 'pass', fromId: 1, toId: 4 }
                ]
            },
            { // Step 3: Second Big/Guard Cuts and Safety
                description: "Second Big (3) cuts to the basket (= Option 3). Second Guard (2) cuts to the 3-point line as the safety.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 1, y: 50, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 40, y: 75, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 50, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 23, y: 15, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 1, y: 50, isBall: true }
                ],
                highlight: [2, 3],
                actions: [
                    { type: 'pass', fromId: 1, toId: 2 }
                ]
            },
            { // Step 4: Final Options (Ball passed to 2) - 2 now has ball
                description: "Ball is passed to the safety Guard (2). Big (5) sets a **screen** for Big (4) to cut to the basket.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 40, y: 50, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 40, y: 75, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 7.5, y: 50, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 7.5, y: 45, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 23, y: 15, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 40.5, y: 75, isBall: true }
                ],
                highlight: [1, 2, 4, 5, 6],
                actions: [
                    { type: 'screen', fromId: 5, toId: 4 } 
                ]
            }
        ],
        HighLow: [
             { // Step 0: Starting Position (Point Guard past the arc)
                description: "Initial Setup: Point Guard (1) at the high top, past the 3-point arc. Bigs (4 - High Post, 5 - Low Post).",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 35, y: 50, isBall: false }, // PG deeper
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 40, y: 85, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 20, y: 35, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 35.5, y: 50, isBall: true } // Ball with PG
                ],
                highlight: [1, 6],
                actions: []
            },
            { // Step 1: Pass to High Post
                description: "1 passes to the High Post (4). 1 cuts to the corner. Low Post (5) sets up for the pass.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 23, y: 15, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 40, y: 85, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 20, y: 35, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 20.5, y: 35, isBall: true } // Ball with 4
                ],
                highlight: [1, 4, 6],
                actions: [
                    { type: 'pass', fromId: 1, toId: 4 } 
                ]
            },
            { // Step 2: High/Low Action
                description: "High Post (4) passes (dumps) to the Low Post (5) for a quick finish.",
                positions: [
                    { id: 1, label: '1', color: '#ef4444', x: 23, y: 15, isBall: false }, 
                    { id: 2, label: '2', color: '#f59e0b', x: 25, y: 15, isBall: false }, 
                    { id: 3, label: '3', color: '#10b981', x: 40, y: 85, isBall: false }, 
                    { id: 4, label: '4', color: '#3b82f6', x: 20, y: 35, isBall: false }, 
                    { id: 5, label: '5', color: '#8b5cf6', x: 7.5, y: 35, isBall: false }, 
                    { id: 6, label: 'üèÄ', color: 'none', x: 8, y: 35, isBall: true } // Ball with 5
                ],
                highlight: [5, 6],
                actions: [
                    { type: 'pass', fromId: 4, toId: 5 } 
                ]
            },
        ]
    };
    
    // --- Utility Functions ---

    /**
     * Custom toast notification function (replaces alert()).
     */
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('opacity-100', 'visible');
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'visible');
        }, duration);
    }

    /**
     * Draws the 3-point lines based on NBA specifications.
     */
    function refresh3pt() {
      const leftRimX = RIM_FROM_BASELINE_FT * SCALE;
      const rightRimX = (COURT_LENGTH_FT - RIM_FROM_BASELINE_FT) * SCALE;
      const cy = (COURT_WIDTH_FT / 2) * SCALE; // 250

      const sideLineLength = THREE_POINT_SIDE_FT * SCALE;
      const r = THREE_PT_RADIUS_FT * SCALE;
      const halfW = (COURT_WIDTH_FT * SCALE) / 2;

      // Left 3pt line
      const leftX_ArcStart = leftRimX + Math.sqrt(Math.max(0, r * r - sideLineLength * sideLineLength));
      const leftY_StraightEnd = halfW - sideLineLength;
      document.getElementById('left3pt').setAttribute('d', 
        `M 0 ${leftY_StraightEnd} L ${leftX_ArcStart} ${leftY_StraightEnd} A ${r} ${r} 0 0 1 ${leftX_ArcStart} ${halfW + sideLineLength} L 0 ${halfW + sideLineLength}`
      );
      
      // Right 3pt line
      const rightX_ArcStart = rightRimX - Math.sqrt(Math.max(0, r * r - sideLineLength * sideLineLength));
      const rightY_StraightEnd = halfW - sideLineLength;
      document.getElementById('right3pt').setAttribute('d', 
        `M 940 ${rightY_StraightEnd} L ${rightX_ArcStart} ${rightY_StraightEnd} A ${r} ${r} 0 0 0 ${rightX_ArcStart} ${halfW + sideLineLength} L 940 ${halfW + sideLineLength}`
      );
    }
    
    /**
     * Converts a player's ID and step data to its center coordinates in the 940x500 SVG ViewBox.
     * @param {object} player - The player's position object {id, x, y}.
     * @returns {{x: number, y: number}} SVG coordinates.
     */
    function getSvgCoordinates(player) {
        // Player X is based on 0-100% of the 94ft court (940 units)
        const svgX = player.x * 9.4; 
        // Player Y is based on 0-100% of the 50ft court (500 units)
        const svgY = player.y * 5; 
        
        return { x: svgX, y: svgY }; 
    }

    /**
     * Initializes the lastStepPositions state based on the current step data.
     */
    function initializePositions(stepData) {
        const initialPositions = {};
        stepData.positions.forEach(p => {
            initialPositions[p.id] = getSvgCoordinates(p);
        });
        lastStepPositions = initialPositions;
    }

    /**
     * Renders the current step, including token positions, movement lines, and explicit actions.
     */
    function renderStep() {
        if (!currentPlay) return;

        const playData = PLAYBOOK[currentPlay];
        const stepData = playData[currentStepIndex];
        const currentPositions = {}; 
        
        // Remove old lines instantly
        actionLinesGroup.innerHTML = ''; 
        
        const tokens = courtInner.querySelectorAll('.token');
        const tokenMap = {};
        tokens.forEach(t => {
            const id = Number(t.dataset.id);
            tokenMap[id] = t;
            // Remove highlight class for tokens not involved in this step
            t.classList.remove('highlighted');
        });

        // 1. Calculate positions, draw movement/dribble lines, and update HTML positions
        stepData.positions.forEach(p => {
            const el = tokenMap[p.id];
            if (el) {
                const size = p.isBall ? ballBaseSize : playerBaseSize;
                const halfSize = size / 2;
                
                // Set the display position relative to the court size
                const displayX = isFullCourt ? p.x : p.x * 2;
                
                // Current SVG Coordinates
                const currentSvgCoords = getSvgCoordinates(p);
                
                // Check for movement from the LAST step
                const lastCoords = lastStepPositions[p.id];

                if (lastCoords && (lastCoords.x !== currentSvgCoords.x || lastCoords.y !== currentSvgCoords.y)) {
                    
                    const line = document.createElementNS("http://www.w3.org/2000/svg", 'line');
                    line.classList.add('play-action-line', 'movement-line');
                    line.setAttribute('x1', lastCoords.x);
                    line.setAttribute('y1', lastCoords.y);
                    line.setAttribute('x2', currentSvgCoords.x);
                    line.setAttribute('y2', currentSvgCoords.y);

                    if (p.id === 6) { 
                        // Dribble Line (Orange/Thick Dashed) - only for the Ball Token (ID 6)
                        line.setAttribute('stroke', '#f97316'); 
                        line.setAttribute('stroke-width', '4');
                        line.setAttribute('stroke-dasharray', '10, 5'); 
                    } else {
                        // Cut/Movement Line (Grey/Dotted)
                        line.setAttribute('stroke', '#6b7280'); 
                        line.setAttribute('stroke-width', '3');
                        line.setAttribute('stroke-dasharray', '4, 4'); 
                    }
                    
                    actionLinesGroup.appendChild(line);
                }

                // Set visual position (HTML Div)
                el.style.left = `calc(${displayX}% - ${halfSize}px)`;
                el.style.top = `calc(${p.y}% - ${halfSize}px)`;

                // Apply highlight
                if (stepData.highlight.includes(p.id)) {
                    el.classList.add('highlighted');
                }
                
                // Store current position for the next step's calculation
                currentPositions[p.id] = currentSvgCoords;
            }
        });

        // 2. Explicit Action Generation (Passes and Screens)
        if (stepData.actions && stepData.actions.length > 0) {
            stepData.actions.forEach((action) => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", 'line');
                line.classList.add('play-action-line', 'explicit-action');

                // Get SVG center coordinates for the source and target from current positions
                const fromPlayer = stepData.positions.find(p => p.id === action.fromId);
                const toPlayer = stepData.positions.find(p => p.id === action.toId);
                
                if (!fromPlayer || !toPlayer) return;

                const startCoords = getSvgCoordinates(fromPlayer);
                const endCoords = getSvgCoordinates(toPlayer);

                line.setAttribute('x1', startCoords.x);
                line.setAttribute('y1', startCoords.y);
                line.setAttribute('x2', endCoords.x);
                line.setAttribute('y2', endCoords.y);

                if (action.type === 'pass') {
                    line.setAttribute('stroke', '#ef4444'); // Red for passes
                    line.setAttribute('stroke-width', '4');
                    line.setAttribute('stroke-dasharray', '12, 8'); 
                } else if (action.type === 'screen') {
                    line.setAttribute('stroke', '#3b82f6'); // Blue for screens
                    line.setAttribute('stroke-width', '6'); 
                    line.setAttribute('stroke-dasharray', '0');
                }
                
                actionLinesGroup.appendChild(line);
            });
        }

        // 3. Update global state for next iteration
        lastStepPositions = currentPositions;

        // 4. Update instructions and button state
        playDescription.innerHTML = `<span class="font-bold text-indigo-700">Step ${currentStepIndex + 1} of ${playData.length}:</span> ${stepData.description}`;
        
        // Ensure buttons are only enabled once a play is loaded
        const playLoaded = !!currentPlay;
        playPauseButton.disabled = !playLoaded;
        nextButton.disabled = !playLoaded || currentStepIndex === playData.length - 1;
        prevButton.disabled = !playLoaded || currentStepIndex === 0;

        // If at the end of the play while animating, pause it
        if (currentStepIndex === playData.length - 1 && isPlaying) {
            togglePlayPause();
            showToast(`Play **${currentPlay}** complete! Reset to run again.`, 5000);
        }
    }

    /**
     * Toggles the play/pause state and controls the animation loop.
     */
    function togglePlayPause() {
        if (!currentPlay) return;

        isPlaying = !isPlaying;
        
        if (isPlaying) {
            playPauseButton.classList.remove('pause-state');
            playPauseButton.classList.add('play-state');
            runAnimation();
        } else {
            playPauseButton.classList.remove('play-state');
            playPauseButton.classList.add('pause-state');
            clearTimeout(animationTimeout);
        }
    }

    /**
     * Recursive function to run the play automatically.
     */
    function runAnimation() {
        if (!isPlaying) return;

        if (currentStepIndex < PLAYBOOK[currentPlay].length - 1) {
            // Move to next step after the duration of the current movement animation
            animationTimeout = setTimeout(() => {
                currentStepIndex++;
                renderStep();
                runAnimation(); 
            }, ANIMATION_DELAY); // Wait for the CSS transition to complete
        } else {
            // End of the play
            togglePlayPause();
        }
    }


    /**
     * Renders the player tokens onto the court DOM based on the current step's positions.
     */
    function createTokens() {
      // Clear existing tokens
      courtInner.querySelectorAll('.token').forEach(t => t.remove());
      actionLinesGroup.innerHTML = ''; // Clear lines when resetting
      
      const initialPositions = currentPlay ? PLAYBOOK[currentPlay][0].positions : [];
      
      initialPositions.forEach(p => {
        const d = document.createElement('div');
        d.className = 'token' + (p.isBall ? ' ball' : '');
        d.textContent = p.label;
        d.dataset.id = p.id;
        if (!p.isBall) d.style.background = p.color;
        courtInner.appendChild(d);
      });
      
      // Initialize state for movement tracking before first render
      initializePositions(PLAYBOOK[currentPlay][0]);
      
      // Set initial positions for the loaded play (will redraw based on step 0)
      renderStep();
    }

    /**
     * Initializes a new play and resets to Step 0.
     */
    function loadPlay(playName) {
        // Pause any running animation
        if (isPlaying) togglePlayPause();

        currentPlay = playName;
        currentStepIndex = 0;
        
        // Update tab styling
        document.querySelectorAll('.play-tab').forEach(tab => {
            if (tab.dataset.play === playName) {
                tab.classList.add('border-indigo-600', 'text-indigo-600');
                tab.classList.remove('border-transparent', 'text-gray-500');
            } else {
                tab.classList.remove('border-indigo-600', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            }
        });

        // Set up initial state and render
        createTokens();
        showToast(`Play **${playName}** loaded.`);
    }

    // --- Event Listeners ---
    
    // Play/Pause Button
    playPauseButton.addEventListener('click', togglePlayPause);
    
    // Toggle Button (Full/Half Court)
    toggleButton.addEventListener('click', () => {
      // Pause animation if running
      if (isPlaying) togglePlayPause();

      const btn = document.getElementById('toggle');
      const svg = document.getElementById('courtSVG');
      
      if (isFullCourt) {
        // Full Court -> Half Court
        svg.setAttribute('viewBox','0 0 470 500'); // Crop to left half (0-470)
        document.getElementById('midLine').style.display = 'none';
        document.getElementById('midCircle').style.display = 'none';
        document.getElementById('rightEnd').style.display = 'none'; 
        btn.textContent = 'Toggle: Half Court ‚Üí Full Court';
        isFullCourt = false;
      } else {
        // Half Court -> Full Court
        svg.setAttribute('viewBox','0 0 940 500'); // Full view (0-940)
        document.getElementById('midLine').style.display = '';
        document.getElementById('midCircle').style.display = '';
        document.getElementById('rightEnd').style.display = ''; 
        btn.textContent = 'Toggle: Full Court ‚Üí Half Court';
        isFullCourt = true;
      }
      
      // Reset positions state to force correct rendering on new court size
      if (currentPlay) {
          initializePositions(PLAYBOOK[currentPlay][currentStepIndex]);
          renderStep();
      }
    });

    // Reset Play Button
    document.getElementById('reset-play').addEventListener('click', () => {
        if (!currentPlay) {
            showToast("Please select a play first.");
            return;
        }
        if (isPlaying) togglePlayPause(); // Pause if running
        currentStepIndex = 0;
        initializePositions(PLAYBOOK[currentPlay][0]); // Reset starting point for movement
        renderStep();
        showToast(`Play **${currentPlay}** reset to Step 1.`);
    });
    
    // Previous Step Button
    prevButton.addEventListener('click', () => {
        if (currentPlay && currentStepIndex > 0) {
            if (isPlaying) togglePlayPause(); // Pause if running
            currentStepIndex--;
            // To ensure smooth visual transition when moving backward, 
            // we must set the lastStepPositions to the step BEFORE the target step.
            const prevStepData = PLAYBOOK[currentPlay][currentStepIndex === 0 ? 0 : currentStepIndex - 1];
            initializePositions(prevStepData);
            renderStep();
        }
    });

    // Next Step Button
    nextButton.addEventListener('click', () => {
        if (currentPlay && currentStepIndex < PLAYBOOK[currentPlay].length - 1) {
            if (isPlaying) togglePlayPause(); // Pause if running
            currentStepIndex++;
            renderStep();
        } else if (currentPlay) {
            showToast(`Play **${currentPlay}** complete! Reset to run again.`);
        } else {
            showToast("Please select a play first.");
        }
    });

    // Tab Handlers
    document.querySelectorAll('.play-tab').forEach(tab => {
        tab.addEventListener('click', (e) => loadPlay(e.target.dataset.play));
    });

    // --- Initialization ---
    window.onload = function() {
        refresh3pt();
        // Automatically load the first play (Motion) on start
        loadPlay('Motion');
    };

    window.addEventListener('resize', refresh3pt);
  </script>
</body>
</html>

